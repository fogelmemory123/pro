<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×”×¨×©××” ×œ××™×¨×•×¢</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(to right, #e3f2fd, #fff);
      direction: rtl;
      padding: 40px;
    }

    .container {
      max-width: 800px;
      background: #fff;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .event-info p {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .btn-primary {
      padding: 12px 24px;
      font-size: 1.1rem;
      border-radius: 30px;
    }

    #registerSuccess, #registerError {
      font-weight: bold;
      margin-top: 15px;
      display: none;
    }

    #registerSuccess {
      color: #28a745;
    }

    #registerError {
      color: #dc3545;
    }

    .list-group-item {
      font-size: 1rem;
    }

    .event-title {
      color: #0d6efd;
      font-weight: bold;
      font-size: 2rem;
      margin-bottom: 30px;
    }

    .section-title {
      border-bottom: 2px solid #ccc;
      padding-bottom: 8px;
      margin-bottom: 20px;
      font-size: 1.25rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center event-title">×¤×¨×˜×™ ×”××™×¨×•×¢</div>

    <div class="event-info">
      <p><strong>ğŸ“… ×ª××¨×™×š:</strong> <span id="eventDate"></span></p>
      <p><strong>ğŸ“ ×ª×™××•×¨:</strong> <span id="eventDescription"></span></p>
      <p><strong>ğŸ“ ×¡× ×™×£:</strong> <span id="branchCity"></span></p>
      <p id="lecturerLine" style="display:none;"><strong>ğŸ¤ ××¨×¦×”:</strong> <span id="lecturerName"></span></p>
    </div>

    <div class="text-center">
      <button onclick="registerToEvent()" class="btn btn-primary">×”×™×¨×©× ×œ××™×¨×•×¢</button>
      <p id="registerSuccess">âœ… × ×¨×©××ª ×‘×”×¦×œ×—×” ×œ××™×¨×•×¢!</p>
      <p id="registerError">âŒ ×©×’×™××” ×‘×”×¨×©××”. × ×¡×” ×©×•×‘.</p>
    </div>

    <hr class="my-5">

    <div class="section-title text-center">ğŸ‘¥ ×¨×©×™××ª ××©×ª×ª×¤×™×</div>
    <ul id="participantList" class="list-group"></ul>
  </div>

  <script>
    const apiUrl = "http://localhost:5000";
    const participantApi = `${apiUrl}/api/participants`;

    function getEventIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function loadEventDetails() {
      const id = getEventIdFromURL();
      if (!id) return;

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${apiUrl}/calendar/events`, {
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const allEvents = await res.json();
        const event = allEvents.find(e => e.id == id);
        if (!event) throw new Error("××™×¨×•×¢ ×œ× × ××¦×");

        document.getElementById("eventDate").textContent = event.date;
        document.getElementById("eventDescription").textContent = event.event_description;
        document.getElementById("branchCity").textContent = event.branch_city;

        if (event.lecturer_name) {
          document.getElementById("lecturerName").textContent = event.lecturer_name;
          document.getElementById("lecturerLine").style.display = 'block';
        }

        loadParticipants(id);
      } catch (err) {
        alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”××™×¨×•×¢");
        console.error(err);
      }
    }

    async function registerToEvent() {
  const token = localStorage.getItem('token');
  const eventId = getEventIdFromURL();

  try {
    const res = await fetch(`${participantApi}/register`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ event_id: eventId })
    });

    const result = await res.json();

    if (res.ok) {
      document.getElementById("registerSuccess").textContent = result.message || "× ×¨×©××ª ×‘×”×¦×œ×—×” ×œ××™×¨×•×¢!";
      document.getElementById("registerSuccess").style.display = 'block';
      document.getElementById("registerError").style.display = 'none';
      
      // âœ… ×˜×•×¢×Ÿ ××—×“×© ××ª ×¨×©×™××ª ×”××©×ª×ª×¤×™×
      loadParticipants(eventId);
    } else {
      document.getElementById("registerSuccess").style.display = 'none';
      document.getElementById("registerError").textContent = result.message || "×©×’×™××” ×‘×”×¨×©××”";
      document.getElementById("registerError").style.display = 'block';
    }
  } catch (err) {
    console.error("×©×’×™××” ×‘×”×¨×©××”:", err);
    document.getElementById("registerSuccess").style.display = 'none';
    document.getElementById("registerError").textContent = "×©×’×™××” ×‘×”×¨×©××”. × ×¡×” ×©×•×‘.";
    document.getElementById("registerError").style.display = 'block';
  }
}


    async function loadParticipants(eventId) {
      try {
        const res = await fetch(`${participantApi}/public/event/${eventId}/participants`);
        const list = document.getElementById("participantList");
        list.innerHTML = "";

        if (!res.ok) {
          const errData = await res.json();
          const li = document.createElement("li");
          li.className = "list-group-item text-danger";
          li.textContent = errData.message || "×©×’×™××” ×‘×¦×¤×™×™×” ×‘××©×ª×ª×¤×™×";
          list.appendChild(li);
          return;
        }

        const participants = await res.json();
        if (participants.length === 0) {
          const li = document.createElement("li");
          li.className = "list-group-item text-muted";
          li.textContent = "×¢×“×™×™×Ÿ ×œ× × ×¨×©××• ××©×ª×ª×¤×™× ×œ××™×¨×•×¢ ×”×–×”.";
          list.appendChild(li);
        } else {
          participants.forEach(p => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = p.name;
            list.appendChild(li);
          });
        }
      } catch (err) {
        console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª×ª×¤×™×:", err);
        const list = document.getElementById("participantList");
        list.innerHTML = `<li class="list-group-item text-danger">×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª×ª×¤×™×</li>`;
      }
    }

    loadEventDetails();
  </script>
</body>
</html>
